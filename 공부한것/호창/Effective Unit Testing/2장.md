# 2장 좋은 테스트란?

## 좋은 테스트의 고려 사항

- 테스트 코드의 가독성과 유지보수성
- 프로젝트, 소스 파일 안에서 코드가 적절히 구조화되어 있는가?
- 테스트가 검사하는 것이 무엇인가?
- 테스트는 안정적이고 반복 가능한가?
- 테스트가 테스트 더블을 잘 활용하는가?
<br>

### 테스트 코드의 가독성과 유지보수성

- 자동화된 테스트는 결함을 효과적으로 막아주지만, 테스트 역시 코드라서 **가독성 문제**(읽기 어려운 코드일수록 결함 수가 많다)에서 벗어날 수 없다.
- 읽기 어려운 코드는 검증하기도 어렵고, 결과적으로 테스트를 조금만 작성하는 사태까지 이어짐
- 레거시(legacy) : 다른 사람에게 넘겨받은 읽기 어렵고 수정하기 어려운 오래된 코드
    - 다른 누군가로부터 물려받아 우리가 관리해야 하기 때문
<br>

### 프로젝트, 소스 파일 안에서 코드가 적절히 구조화되어 있는가?

- 구조화가 잘 되어 있으면 이해하기 쉽다, 제대로 된 구조 → 고수준 개념을 구현된 코드에 빠르고 정확하게 대입할 수 있는 구조
- 하지만, 제대로 구조화가 되어 있지 않으면, 나누지 않느니만 못할 수 있다.
- 테스트 코드가 제대로 구조화되어 있지 않을 경우 → 어느 곳을 손봐야 하는지 찾아내기 어렵다
- 테스트 코드가 제대로 구조화되어 있을 경우 장점
    1. 현재 작업과 관련된 테스트 클래스를 찾을 수 있다
    2. 그 클래스에서 적절한 테스트 메서드를 를 수 있다
    3. 그 메서드에서 사용하는 객체의 생명 주기를 이해할 수 있다.
<br>

### 테스트가 검사하는 것이 무엇인가?

- 올바른 것을 검사하는 것 못지않게 올바른 것을 똑바로 검사하는 것도 중요
- 특히 유지 보수 관점에서는 어떻게 구현했느냐가 아니라 의도한 대로 구현했느냐를 검사하는 것이 중요
- 보통 테스트 이름을 보면 그 테스트가 검사하는 내용을 알 수 있는데, 실제로는 이름과 관련 없는 엉뚱한 것을 검사하는 경우가 있는데, 이는 올바른 것을 것을 똑바로 검사하지 못하는 것.

### 테스트는 안정적이고 반복 가능한가?

- 코드 냄새
    - 코드에서 풍기는 냄새는 무언가 잘못되었을 수 있다는 신호
- 테스트 코드가 얼마나 **독립적인지(종속성이 없는지)가 중요**하다
    - 격리와 독립성이 중요한 이유는 그것이 없으면 테스트를 실행하고 관리하기가 훨씬 어렵기 때문이다. → 단위 테스트를 실행하기 위해 개발자가 해야 할 귀찮은 작업이 많아짐(파일 시스템 특정 위치에 빈 디렉터리 만들거나 테스트가 사용할 로그인 정보를 db에 미리 추가)
    - 테스트를 서로 종속되지 않게 해야 한다(독립적) → 한 클래스의 테스트가 다른 클래스의 테스트 실행 여부나 그 결과에 의존하면 안된다는 의미(같은 테스트 클래스에 속한 테스트 메서드끼리도 순서를 가정하면 안됨 )
- 시간, 임의성, 동시성, 인프라, 영속성, 기존 데이터, 네트워킹 간련 코드를 검사할 때는 이들과의 종속성을 최대한 피하는 것이 최선이고 아니면 작고 격리된 단위로 구분해서 이 복잡한 상황으로부터 다른 테스트를 보호해야 함
    - 이런 종속성들은 *우리가 제어할 수 없다는 특징*이 있다. 이런 종속성 때문에 생겨나는 불규칙한 테스트 실패를 테스트 더블로 교체하거나 원하는 대로 동작하는 환경에 코드를 고립시켜서라도 원하는 결과를 나오게 하고 싶어 한다.(**제어하고 싶어 함**)

- 테스트를 믿고 의지하려면 반복했을 때 모두 일관된 결과가 나와야 한다
    - 애플리케이션이 비동기적 요소나 현재 시각에 종속된 코드를 포함한다면 그 부분을 인터페이스로 감싸 격리하고, 그렇게 하면 테스트 더블로 대체할 수 있어 반복 가능한 테스트를 만들 수 있다.
- 실전에서는 테스트의 **종속성을 제거**하기 위해 어떻게 해야 할까?
    1. 테스트 더블로 서드파티 라이브러리와의 종속성을 제거 → 손수 만든 어뎁터로 적절히 감싸주면 성가신 부분이 어뎁터 안으로 감춰지므로 나머지 애플리케이션 로직과 분리해서 검사할 수 있다
    2. 테스트에 필요한 자원을 테스트 코드와 같은 위치에 둔다(자바 프로젝트라면 같은 패키지에 두면 된다)
    3. 테스트가 사용할 자원을 직접 만들도록 한다
    4. 테스트가 필요한 문맥을 직접 설정하게 함, 절대 다른 테스트에 의존하지 말자
    5. 영속성이 필요한 통합 테스트라면 인메모리 db를 활용한다, 테스트를 위한 깨꿋한 데이터를 훨씬 간단하게 준비할 수 있고 덤으로 초기화 시간도 상당히 단축 됨
    6. 스레드를 사용하는 코드는 동기식과 비동기식을 구분 지어 동시성 문제는 소규모의 전문 테스트 그룹에 맡김, 평범한 동기식 코드로 작성된 나머지 로직 대부분은 별다른 어려움 없이 검사할 수 있게 된다
    
<br>

### 테스트가 테스트 더블을 잘 활용하는가?

- 테스트 더블 : 스텁, 가짜 객체, Mock 객체 등으로 알고 있는 개념들을 통칭하는 용어, 테스트를 위해 실체 구현체와 교체할 수 있는 객체
- 테스트 더블 장점
    - 원래의 로직을 간소화된 코드로 대체하여 테스트 속도를 개선한다
    - 만들어내기 어려운 특수한 상황을 시뮬레이션한다
    - 대상 객체의 내부 상태나 동작 등 테스트가 접근할 수 없던 정보를 얻어낸다.
<br>

### 정리

- 좋은 테스트를 만드는 요소들에 대해 알아봄
- 가독성이 좋지 않으면(이해할 수 없는 테스트 코드는) 유지 보수하기 어렵게 됨
- 잘 구조화된 테스트라면 원하는 코드를 빠르게 찾을 수 있고, 논리 흐름도 쉽게 이해할 수 있다 → 구조화된 테스트가 유용한 테스트 제작에 중요한 이유 → 가독성과도 직결되는 특성
- 엉뚱한 것을 검사하는 테스트는 개발자를 잘못된 길로 안내하거나 본질을 흐려버려 테스트가 의도했던 진짜 논리를 감추고 가독성을 떨어뜨리는 결과를 낳음
- 가끔 의심스러운 동작(가끔 테스트 실패)을 하는 테스트에서 원인을 찾아내고 반복할 수 있게 만드는 것이 테스트에서 매우 중요함
- 자동화된 테스트 작성을 보조해주는 필수 도구 3가지
    - **테스트 프레임워크**
    - 프레임워크로 작성한 테스트를 실행해줄 **자동 빌드**
    - 검사할 수 있는 범위를 넓혀주는 **테스트 더블**
