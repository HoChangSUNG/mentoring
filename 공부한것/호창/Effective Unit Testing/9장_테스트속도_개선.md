# 9장 테스트 속도 개선

## 9.1 속도 개선을 위해서

- 피드백이 늦어질수록 피해가 커지기 때문에 테스트가 빨리 끝나야 함
    - 빌드가 너무 늦어저서 개발자가 일부 테스트만 수행한 후 나머지는 빌드 서버에 맡긴 채 다음 작업을 하는데, 빌드 서버가 뒤늦게 문제를 발견하면 개발자는 하던 일을 멈추고 이전 작업을 검토해야 해서 집중력도 잃고 생산성도 떨어짐
- 피드백 주기 단축을 위해 손댈 수 있는 영역
    1. 코드 속도 높이기
    2. 빌드 속도 높이기

<br>

## 9.2 테스트 코드 속도 높이기

### 테스트를 느려지게 할 수 있는 위험 요소

1. **피곤하지 않다면 잠들지 말라**
    - 테스트가 필요 이상 멈춰있게 해서는 안된다
    - Thread.sleep() 대신 동기화 객체를 사용하여 신뢰성 있는 결과를 얻을 수 있음
2. **덩치 큰 기반 클래스를 경계하라**
    - 테스트 속도의 저하 원인 중에는 개발자가 만든 기반 클래스도 포함됨
    - 구조적인 성능 저하 요인
        - Junit이 테스트를 실행하는 방식으로 인해 발생 → 리플랙션을 이용해 전체 클래스 계층 구조를 훑으면서 하위 클래스가 사용하지 않는 셋업과 티어 다운을 매번 실행해서
        - 따라서 계층이 깊어질수록 필요없는 셋업과 티어다운의 수도 많아지고 계층을 오르내리는 데 낭비되는 CPU시간도 길어짐
    - 테스트가 사용하지도 않을 것을 준비하느라 느려지게 하는 건 바람직하지 않음
3. **불필요한 셋업과 티어다운을 경계하라**
    - Junit에서 셋업과 티어 다운 : @Before,@After 라는 애노테이션이 붙은 특수한 메서드
    - 셋업과 티어 다운은 테스트 하나당 한번씩 실행되어 성능 면에서 방해가 될 수 있음
        - @Before,@After를 실행할 필요가 없는 테스트 메서드가 섞여 있더라도 실행되기 때문에 이러한 작은 시간 낭비가 계속 누적될 수 있음
    - 한번만 실행해도 되는 셋업은 @BeforeClass,@AfterClass로 바꿔주면 됨
    - @Before,@After의 가치는 높지만, 빌드가 느려진다면 셋업과 티어다운에서 시간을 얼마나 잡아먹는지, 그리고 이유없이 실행되고 있지는 않은지 확인해볼 필요가 있음
4. **테스트에 초대할 손님은 까다롭게 선택하라**
    - 테스트 시간을 단축하려면 테스트가 수행하는 코드의 양을 줄여라 → 정확하게는 테스트와 관련 없는 협력 객체를 잘라내어 테스트 대상의 범위를 가능한 한 좁혀라
5. **로컬하게, 그리고 빠르게 유지하라**
    - 메모리에서 데이터를 읽는 것보다 클라우드 서비스에서 가져오려면 10만배는 더 걸린다 → 테스트를 가능한 로컬하게 유지하고 네트워크 사용을 배제하자
    - 네트워크를 사용하는 부분은 테스트 더블로 대체하여 테스트를 격리하고, 결정적인 결과를 얻을 수 있고, 네트워크 장애와 같은 특수 상황도 시뮬레이션 가능하다
    - 정리하면 네트워크 호출을 테스트 더블로 대체하면 커다란 성능 향상을 얻을 수 있고, 단위 테스트에서는 네트워크를 호출하지 않는 것을 기본 원칙으로 한다.
6. **데이터 베이스의 유혹을 뿌리쳐라**
    - 데이터 베이스 접근은 시간이 오래 걸리고, db에 저장할 데이터도 단위 테스트의 검사 내용과는 무관하기 때무넹 데이터 베이스를 되도록 사용하지 않는 것이 좋다.
7. **파일 IO보다 느린 IO는 없다**
    - 테스트를 빠르게 유지하려면 파일 시스템 접근을 최소화해라

<br>

## 9.3 빌드 속도 높이기

1. **램 디스크를 활용한 초고속 I/O**
    - 메모리 일부를 가상 디스크 파티션으로 할당하면 메모리에 바로 읽고 쓰기 때문에 하드 디스크에 비해 빠른 성능을 얻을 수 있음
    - 이와 같은 파일 시스템을 유닉스 계열 시스템에서는 tmpfs로 제공한다.

**2 빌드를 병렬화하기**

- 빌드 대부분을 CPU가 처리하고 있다면 코어를 하나만 사용하는 것보다 다 사용하면 빌드 시간을 단축할 수 있음
- 빌드가 CPU에만 의존하는 것이 아니라 디스크 I/O에도 많은 시간을 소모해도 효과가 좋음
    - 하드 디스크이 응답을 기다리며 CPU가 놀고 있는 시간만큼 개선할 수 있기 때문

<br>

## 정리

9장에서는 테스트 속도를 높이는 두가지 방법을 알아봄

- 테스트 코드에서 속도를 높이기 위해 찾을 수 있는 최적화 요소
    - 필요보다 오래 기다리는 스레드, 복잡한 계층 구조로 인해 불필요한 코드 수행, 적절히 격리되지 못한 테스트, 네트워크를 이용하는 테스트, 파일 시스템을 읽고 쓰는 테스트 등
- 빌드에서 속도를 높이는 방법
    - 하드 디스크를 SSD나 램 디스크로 바꿔 I/O속도 높이는 방법, 속도 저하의 원인이 CPU라면 테스트 스위트를 병렬화, 원격 컴퓨터에 테스트를 분산 실행하는 방법
