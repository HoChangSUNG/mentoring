# Ch3 네트워크의 공통 언어 TCP/IP

### **TCP/IP**

- TCP와 IP를 중심으로 하는 프로토콜 집합
- 네트워크를 통해 통신하기 위한 기능을 계층화하고 복수의 프로토콜을 조합
- 계층
    - **네트워크 인터페이스 층**
        - 같은 네트워크 내 인터페이스 간 데이터 전송 역할
            - 하나의 네트워크 → 라우터, 레어어 3 스위치로 구분되는 범위 또는 레이어 2 스위치로 구성하는 범위
        - 주요 프로토콜 : 이더넷, 무선 LAN(Wi-Fi), PPP 등
    - **인터넷층**
        - 엔드투엔드 통신(원격지 네트워크간 데이터 전송) 역할
        - 주요 프로토콜 : IP,ICMP,ARP 등
            - 엔드투엔드 통신에 사용 → IP
            - IP를 도와주는 프로토콜 → ARP,ICMP
    - **트랜스포트층**
        - 데이터를 적절한 애플리케이션에 배분하는 역할
        - 주요 프로토콜 : TCP/UDP
            - TCP → 신뢰성 확보, 데이터의 분할과 조립, 데이터 재전송 제어, 데이터의 순서 제어 기능 사용 가능
    - **애플리케이션층**
        - 애플리케이션에서 다루는 데이터 형식과 처리 순서 등을 결정하는 역할
        - HTTP, SMTP, POP3, DHCP, DNS 등
            - DHCP, DNS → 애플리케이션에서 이용하지 않고, 애플리케이션의 통신을 준비하기 위한 프로토콜
    
    ※ 네트워크 인터페이스 층을 제외한 계층은 통신 상대와 동일한 프로토콜을 선택해야 함
    
    - 네트워크 인터페이스 층은 무선 LAN(WI-FI), 이더넷과 같이 서로 다른 프로토콜을 사용해도 됨
    

### **캡슐화와 역캡슐화**

**헤더**

- 프로토콜에서 각각의 기능을 실현하기 위한 제어 정보

**캡슐화**

- 각 프로토콜에서 데이터 전송 시 헤더를 추가하는 것

**역캡슐화**

- 프로토콜이 헤더를 바탕으로 처리를 하고, 헤더를 제거해 다른 프로토콜에 처리를 넘기는 것

**데이터 송신 측**

- 웹 브라우저의 데이터에 HTTP 헤더로 캡슐화 → TCP 헤더가 추가 → IP 헤더 추가 → 이더넷 헤더+ FCS 추가
- TCP/IP 계층을 위에서부터 아래로 따라가며 각 프로토콜 헤더를 추가하고, 이더넷에 규격에 대응하는 물리적 신호로 변환해 전송 매체로 데이터 전달

**데이터 수신 측**

- 수신한 물리적인 신호를 원래 데이터로 되돌림
- 이더넷 헤더를 참조해 데이터 확인, FCS로 데이터 오류 검사 → 이더넷 헤더,FCS 제거 후 IP 계층에 데이터 전달 → IP 헤더 이용해 데이터 처리 후 IP 헤더 제거→ TCP 헤더를 참조해 어느 애플리케이션 데이터인지 확인 후 TCP 헤더를 제거하고 애플리케이션으로 데이터 넘김  → HTTP 헤더를 이용해 데이터 처리
- TCP/IP 계층을 아래에서 위로 따라가며 헤더를 참조해 프로토콜 처리

### TCP/IP 계층별 데이터 부르는 방법

- 애플리케이션 층 : 메시지 → HTTP 메시지(웹브라우저 데이터 + HTTP 헤더)
- 트랜스포트 층 : 세그먼트(TCP), 데이터 그램(UDP) → TCP 세그먼트(HTTP 메시지 + TCP 헤더)
- 인터넷층 : 패킷 또는 데이터 그램(=IP 패킷, IP 데이터 그램) → IP 패킷(TCP 세그먼트 + IP 헤더)
- 네트워크 인터페이스층 : 프레임 → 이더넷 프레임(IP 패킷 + 이더넷 헤더 + FCS)

- 라우터 → 인터넷층 네트워크 기기, IP 패킷을 적절히 전송하는 역할
- 레이어 2 스위치 → 네트워크 인터페이스 층에서 동작하는 기기, 이더넷 프레임을 전송하는 역할

### IP

- 엔드투엔드 통신 역할
- IP 헤더에 IP 주소(출발지, 목적지 주소)를 포함해 데이터 전송
- IP로 전송하는 데이터 → 애플리케이션 데이터에 애플리케이션층 프로토콜의 헤더와 트랜스포트층 프로토콜 헤더 추가된 것
- 목적지가 다른 네트워크에 존재할 경우 → 라우터가 라우팅

### IP 주소

- TCP/IP에서 통신 상대가 되는 호스트를 식별하기 위한 식별 정보, TCP/IP 통신에서 반드시 IP주소 지정해야 함
- 호스트 내부에서 인터페이스와 IP 프로토콜 부분을 연관지어 IP주소를 설정 → IP 주소는 호스트 자체가 아니라 정확하게는 호스트의 인터페이스를 식별
- 표기
    - 도트형 10진 표기 : 0~255 사이의 숫자를 .으로 구분해 4개 나열하는 형태
- **목적지 개수에 따른 전송 방식 3가지**
    - 유니캐스트 : 단 하나의 목적지에 데이터 전송하는 것
        - 유니케스트로 여러개의 목적지 주소에 데이터 전송 시 목적지 개수만큼 데이터 전송을 반복해야 해서 비효율적
        - 따라서 **완전히 같은 데이터를 복수의 주소로 효율적으로 전송하기 위해 브로드캐스트, 멀티캐스트 사용**
        - IP 주소 : 네트워크부 + 호스트부
    - 브로드캐스트 : 같은 네트워크 상의 모든 호스트에 데이터 전송하는 것
        - IP주소 : 32비트가 모두 1, 255.255.255
    - 멀티캐스트 : 특정 그룹에 포함되는 호스트에 데이터 전송하는 것(멀티 캐스트 그룹에 포함되느 호스트가 반드시 같은 네트워크라고 할 수는 없음)
        - IP주소 : 224.0.0.0 ~ 239.255.255.255
            - 224.0.0.2 → 같은 네트워크 상의 모든 라우터
        

### 네트워크부와 호스트부

- 네트워크부 → 네트워크를 식별
- 호스트부 → 네트워크 내 호스트를 식별

### 서브넷 마스크

- IP주소에서 네트워크부와 호스트부를 나누어주는 것
- 연속한 1 → 네트워크부, 연속한 0 → 호스트부
- 표기
    - 8비트씩 10진수로 변환하고 .으로 구분
    - 프리픽스 표기 : / 뒤에 연속한 1의 개수로 표기(네트워크부), 192.168.1.0/24 → 24비트가 네트워크부, 8비트가 호스트부
- 네트워크 주소 : IP주소에서 호스트부를 모두 비트 0으로 채운 주소
- 브로드캐스트 주소 : IP주소에서 호스트부를 모두 비트 1로 채운 주소

### 네트워크에 접속하기 위한 단계

- 물리적인 접속 : LAN 케이블을 삽입하는 등 물리적인 신호를 주고받을 수 있게 하는 것
- 논리적인 접속 : 인터페이스에 IP 주소를 설정하는 것

### **IP주소 종류**

- 공인 IP 주소(퍼블릭 IP 주소) : 인터넷에서 이용하는 IP 주소, 인터넷 전체에서 중복되지 않도록 관리됨
- 사설 IP 주소 : 사설 네트워크에서 이용하는 IP 주소, 서로 다른 사설 네트워크의 주소가 겹쳐도 사설 네트워크 안의 통신에는 문제가 없음
    - 범위
        - 10.0.0.0 ~ 10.255.255.255
        - 172.16.0.0 ~ 172.31.255.255
        - 192.168.0.0 ~ 192.168.255.255

### **NAT(Network Address Translation)**

- 사설 IP 주소(내부 IP 주소)와 공인 IP 주소(외부 IP 주소)를 매핑시켜 변환해주는 기능
- **인터넷에서 목적지 IP주소가 사설 IP주소인 경우 IP 패킷은 폐기된다**
    - 출발지 IP : 사설 IP 주소, 목적지 IP 주소 : 공인 IP 주소 → 목적지 주소로 패킷이 전달됨
    - 출발지 IP : 공인 IP 주소, 목적지 IP 주소 : 사설 IP 주소 → 인터넷에서 패킷이 폐기됨
- 종류
    - Static NAT
        - 공인 IP와 사설 IP 주소가 1:1로 매핑되는 것
        - 한개의 공인 IP에 사설 IP 주소가 필요하여 주소 절약에는 도움 안됨
    - Dynamic NAT
        - 여러개의 내부 IP주소와 여러개의 외부 IP주소를 동적으로 매핑시키는 방법
        - 동작방식
            1. 호스트가 외부로 보내는 트래픽을 라우터로 보냄
            2. 라우터에 설정된 공인 IP 주소 풀에서 쉬고 있는 IP중 하나로 변환하여 외부로 내보냄
            3. 외부에서 라우터로 트래픽이 돌아오면 라우터는 NAT TABLE에 있는 정보를 확인하고 사설 IP 주소로 변환
    - PAT(Port Address Translation)
        - 하나 또는 하나 이상의 공인 IP 주소를 여러 개의 사설 IP주소들이 공유할 경우에 사용하며 같은 공인 IP 주소로 변환하고 PORT를 다르게 변환하여 주는 방식
        - 공인 IP 주소가 중복되어 PORT 번호를 통해 구분해주는 방식
    

### **ICMP(Internet Control Message Protocol)**

- IP는 최선형(best effort) 방식으로 데이터를 보내기 때문에 데이터가 잘 갔는지 확인이 불가능하다.
    
    따라서 **엔드투엔드 통신이 정상적으로 이루어졌는지 확인하는 기능을 갖춘 프로토콜인 ICMP**가 필요하다
    
    - 최선형(best effort) : 데이터를 보내려 노력은 하지만 결과는 보장하지 않는다는 뜻
- 주요 기능
    - 에러 리포트 : IP 패킷이 폐기된 경우  ICMP 도달불능 메시지를 출발지로 통보하여 엔드투엔드 통신에 실패한 원인 통지
        - 도달불능 메시지 : IP 패킷 폐기시 패킷 폐기한 기기가 폐기한 원인을 출발지로 보내는 에러 리포트
    - 진단 기능 : IP의 엔드투엔드 통신이 가능한지 확인하는 기능
        - ping 커맨드로 지정한 IP주소와 통신할 수 있는지 확인
            - ping 커맨드를 실행하여 ICMP 에코 요청/응답 메시지를 보내 지정한 IP주소와 통신할 수 있는지 확인

### ARP(Address Resolution Protocol)

- IP주소와 인터페이스를 식별하기 위한 MAC 주소를 대응시키기 위해 사용되는 프로토콜
- 주소 해석 : IP주소와 MAC 주소를 대응시키는 것
- ARP의 주소 해석 범위는 같은 네트워크 내의 IP 주소
- 송신측에서 IP 패킷을 송신하고자 목적지 IP주소 지정할 때, 자동으로 ARP 수행 → 목적지 IP 주소에 대응하는 목적지 MAC 주소 구함
- ARP 동작 흐름
    - ARP 요청으로 IP 주소에 대응하는 MAC 주소를 질의한다(ARP 요청을 브로드캐스트해서 MAC 주소 질의)
    - 질의받은 IP 주소를 가진 호스트가 ARP 응답으로 MAC 주소를 알려준다
    - 주소 해석한 IP 주소와 MAC  주소의 대응을 ARP 캐시에 보관

### **포트 번호**

- 애플리케이션을 식별하고 데이터를 적절한 애플리케이션으로 보내주는 식별 번호, TCP 또는 UDP 헤더에 지정
- 16비트로 구성
- 웰노운 포트(well-known port) : 서버 애플리케이션용으로 예약된 포트 번호 → 0 ~ 1023
- 등록된 포트(registered port) : 자주 이용되는 애플리케이션의 서버 쪽 포트 번호 → 1024 ~ 49151
- 동적/사설 포트 : 클라이언트 애플리케이션용 포트 번호 → 49152 ~ 65535

### TCP

- 애플리케이션 사이에서 신뢰성 있는 데이터 전송을 할 수 있음
    - 신뢰성 있는 데이터 전송을 위해 시퀀스 번호(분할하여 보낸 데이터 순서), ACK 번호(데이터를 바르게 수신했음을 확인하는 용도)를 사용
- TCP에 의한 데이터 전송 절차
    1. TCP 커넥션 맺기 → 3 way handshake
    2. 애플리케이션 간 데이터 송수신
    3. TCP 커넥션 끊기
- TCP에서 MSS 단위로 데이터를 나누어 송신
    - MSS(Maximum Segment Size) : TCP에서 애플리케이션의 데이터를 분할하는 단위  
        ![KakaoTalk_20230830_214120991](https://github.com/HoChangSUNG/mentoring/assets/76422685/cc52c0c4-3598-41e8-994f-9e1df2f7af6e)

### UDP

- 애플리케이션에 데이터를 배분하기 위해 사용하는 프로토콜
- 신뢰성이 높지 않고, 크기가 큰 데이터를 분할하는 기능이 없지만, 데이터 전송이 빠르다는 장점이 있음
    - 크기가 큰 데이터는 애플리케이션 쪽에서 적절한 크기로 쪼개야 함
- IP 전화의 음성 데이터와 같은 **실시간 데이터 전송**을 할 때 UDP 사용

### DNS

- 호스트 이름에 대응하는 IP 주소를 자동으로 구해주는 역할, 이름 해석을 제공
    - 이름 해석 : 호스트명에서 IP 주소를 구하는 방법
- DNS 서버 : 호스트명과 IP 주소의 대응 관계를 등록, 리소스 레코드를 등록
    - 리소스 레코드 : DNS 서버에 등록하는 정보
        - 주요 리소스 레코드
            - A → 호스트명에 대응하는 IP 주소
            - AAAA → 호스트 명에 대응하는 IPv6 주소
            - CNAME → 호스트명에 대응하는 별명
            - MX → 도메인명에 대응하는 메일 서버
            - NS → 도메인명을 관리하는 DNS 서버
            - PTR → IP 주소에 대응하는 호스트명
- **동작 방식**
    1. DNS 리졸버가 DNS 서버에 IP 주소를 질의
        - DNS 리졸버 : DNS 서버에 질의하는 기능, 윈도우 등 OS에 내정되어 있음
    2. 루트 DNS 서버부터 계층을 따라 질의를 반복(재귀 질의)
    3. 과거에 질의한 결과가 DNS 서버나 DNS 리졸버에 캐시로 남아 있으면 루트 DNS 서버에 질의하지 않아도 됨 
        
        ![KakaoTalk_20230831_162740024](https://github.com/HoChangSUNG/mentoring/assets/76422685/0a486dcf-4db6-4e4f-a306-e661a86cf0d4)


### DHCP

- 호스트의 TCP/IP 설정을 자동으로 클라이언트에게 제공해주는 프로토콜
    - TCP/IP 설정 항목 → IP주소 / 서브넷 마스크, 기본 게이트웨이 IP 주소, DNS 서버의 IP 주소
- **동작 방식(기본적으로 브로드캐스팅)**
    - DHCP Discover
        - DHCP 클라이언트가 DHCP 서버를 찾기 위해 DHCP Discover 메시지를 브로드캐스트로 전송
    - DHCP Offer
        - DHCP Discover를 수신한 DHCP 서버는 클라이언트에 할당할 IP주소와 서브넷 마스크, 게이트웨이, DNS 정보 등을 포함한 DHCP 메시지를 클라이언트에게 전송
    - DHCP Request
        - 하나의 DHCP 서버를 선택하고 해당 서버에게 단말이 사용할 네트워크 정보(IP주소와 서브넷 마스크, 게이트웨이 등)를 요청
    - DHCP ACK
        - DHCP 클라이언트로부터 IP 주소를 사용하겠다는 요청을 받으면 DHCP 서버에 해당 IP를 어떤 클라이언트가 언제부터 사용하기 시작했는지 정보를 기록하고 DHCP Request 메시지를 정상적으로 수신했다는 응답  
    ![KakaoTalk_20230831_162740024_01](https://github.com/HoChangSUNG/mentoring/assets/76422685/f04058f5-e013-4396-a777-7c57458e09ba)

**NAT 참고 자료**  
https://blog.naver.com/skyhomo/220049937649
