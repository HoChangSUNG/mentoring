# 테스트 시 db를 어떻게 통제할 수 있을까?

## 서론

토비의 스프링 vol.1에서 테스트 관련 부분에 대한 내용을 읽고 다음과 같은 생각이 들었다.

> 테스트에서 DB를 통제하면 멱등성 있는 결과를 얻을 수 있다고 하는데 테스트 환경에서 db를 어떻게 통제할 수 있을까?
> 

위 생각처럼 테스트에서 DB를 통제할 수 있는 방법은 무엇이 있을지 생각해보고 그 방법의 문제점과 이를 개선하기 위한 다른 방법들은 무엇이 있을지 작성해보려고 한다.

내가 생각한 테스트에서 DB를 통제할 수 있는 방법은 크게 4가지이다.

1. 원격 서버에 있는 DB 접근
2. 인 메모리 DB 사용
3. 프로덕션 환경에서 사용하는 DB와 테스트 환경에서 사용하는 DB를 동일하게 맞춰주는 방법
4. TestContainer 사용

[퇴고 전 글](https://github.com/HoChangSUNG/mentoring/blob/main/%EA%B3%B5%EB%B6%80%ED%95%9C%EA%B2%83/%ED%98%B8%EC%B0%BD/%EB%B8%94%EB%A1%9C%EA%B7%B8%20%ED%8F%AC%EC%8A%A4%ED%8C%85/%ED%85%8C%EC%8A%A4%ED%8A%B8_%EC%8B%9C_db%EB%A5%BC_%EC%96%B4%EB%96%BB%EA%B2%8C_%ED%86%B5%EC%A0%9C%ED%95%A0_%EC%88%98_%EC%9E%88%EC%9D%84%EA%B9%8C/%ED%85%8C%EC%8A%A4%ED%8A%B8_%EC%8B%9C_db_%ED%86%B5%EC%A0%9C_%ED%87%B4%EA%B3%A0_%EC%A0%84.md)  
[퇴고 전 피드백](https://github.com/HoChangSUNG/mentoring/blob/main/%EA%B3%B5%EB%B6%80%ED%95%9C%EA%B2%83/%ED%98%B8%EC%B0%BD/%EB%B8%94%EB%A1%9C%EA%B7%B8%20%ED%8F%AC%EC%8A%A4%ED%8C%85/%ED%85%8C%EC%8A%A4%ED%8A%B8_%EC%8B%9C_db%EB%A5%BC_%EC%96%B4%EB%96%BB%EA%B2%8C_%ED%86%B5%EC%A0%9C%ED%95%A0_%EC%88%98_%EC%9E%88%EC%9D%84%EA%B9%8C/%ED%94%BC%EB%93%9C%EB%B0%B1%20%EB%B0%8F%20%EB%B0%98%EC%98%81%EC%82%AC%ED%95%AD.md)

<br>

## 1. 원격 서버에 있는 DB 접근

첫 번째로 생각해본 방법은 개발자들의 PC에 있는 DB에서 테스트하는 것이 아니라 aws rds나 외부의 특정 서버에 설치된 db에 접근하여 테스트하는 것이다.

이 방법의 문제는 다음과 같다.
- 원격 서버에 있는 db에 접근하기 위해서는 인터넷 연결이 필요하다는 점이다.
    - 만약 인터넷에 개발자의 컴퓨터가 접속이 불가능하거나, 원격 서버에 있는 db가 정상적으로 작동하지 않는 등의 문제로 원격 서버에 있는 db에 접근하지 못한다면 db 자체를 사용하지 못하게 된다.

<br>

## 2. 인 메모리 DB 사용

두 번째로 생각해본 방법은 개발자들의 PC에 인메모리 DB를 설치하여 테스트하는 것이다.  
인메모리 DB를 사용한다면 테스트할 때 인터넷에 접근할 필요가 없기 때문에 원격 서버에 있는 DB 접근 방법의 문제점을 해결할 수 있다.  
또한 MySql 등은 디스크에 데이터를 저장하기 때문에 속도가 느리지만, 인메모리 DB는 메모리에 저장하기 때문에 속도가 빠르다는 장점이 있다.  

하지만 이 방법 또한 다음과 같은 문제가 있다.
- 제품 코드가 사용하는 DB 환경과 테스트 코드를 실행하는 DB 환경이 다르다는 것이 문제가 된다.
- 예를 들어 테스트 환경에서는 H2를 사용하고 프로덕션 환경에서는 MySql을 사용하자고 하자.  
    테스트 환경에서는 올바르게 동작하는데, 프로덕션 환경에서는 테스트 환경과 DB가 다르기 때문에 쿼리가 제대로 동작하지 않을 수 있다.
    
<br>

## 3. 프로덕션 환경에서 사용하는 DB와 테스트 환경에서 사용하는 DB를 동일하게 맞춰주는 방법

세 번째로 생각해본 방법은 프로덕션 환경에서 사용하는 DB를 테스트 환경에서도 사용하는 것이다.  
제품 코드가 사용하는 DB 환경과 테스트 코드를 실행하는 DB 환경이 달라 발생하는 문제를 해결할 수 있다.  

하지만 이 방법 또한 다음과 같은. 문제가 있다.
- 테스트를 실행하는 pc마다 테스트에 사용할 db를 설.치하고 환경을 구축한 후에 테스트해야 한다는 문제이다.
    - 이 문제는 개발자가 추가될 때마다 테스트 db 환경을 개발자의 pc에 구축해야 한다는 귀찮음이 존재한다.

<br>

## 4. TestContainer 사용

마지막으로 생각해본 방법은 TestContainer를 사용하는 것이다.  
도커만 설치되어 있다면 도커 이미지를 다운 받아 로컬 환경에서 동일한 테스트 환경을 쉽게 구축할 수 있고, container 마다 독립적으로 수행되어 **멱등성을 보장**할 수 있다.  

하지만 이러한 TestContainer도 단점이 존재한다.
- 독립적인 테스트 환경이 많아질수록 시간이 오래 걸린다.
- 도커 컨테이너를 사용하여 테스트 환경을 구성해 로컬 환경의 리소스가 충분해야 한다.
- 테스트 속도가 느릴 수 있다.
    - docker container  시작과 종료시 시간이 걸리기 때문이다.

**Test Container란?**
- 통합 테스트를 지원하기 위해 개발된 오픈 소스 Java 라이브러리이다.
- 도커 컨테이너를 활용하여 외부 의존성들을 포함한 테스트 환경을 구축하고 관리하는 것을 간편하게 해주고, container마다 독립적으로 수행되어 멱등성을 유지해준다.
    
<br>

## 결론

### 정리

테스트에서 DB를 통제할 수 있는 방법은 무엇이 있을지 생각해보고 그 방법의 문제점과 이를 개선하기 위한 다른 방법들은 무엇이 있는지 알아보았다.  
속도가 느리고, 충분한 리소스가 필요하다는 단점이 존재하지만 멱등성을 보장하고 환경 설정의 편리함이 있는 TestContainer가 위의 방법들 중 테스트 db를 통제하기에 가장 적절하다고 생각한다.  
다음에는 **TestContainer**에 대해 자세히 알아보자.

### 생각
이전 프로젝트들에서 통합 테스트를 진행하면서, 멱등성을 유지하면서 테스트 환경을 쉽게 설정할 수 있는 방법을 고민했었는데, 이번 기회를 통해 이 고민을 해결할 수 있는 실마리를 얻었다.
