# 테스트 시 db를 어떻게 통제할 수 있을까?

## 서론

토비의 스프링 vol.1을 읽는 도중 아래와 같은 내용을 발견했다

> 어떤 개발자는 테스트 중에 DB가 사용되면 단위 테스트가 아니라고도 한다. 그럼 UserDaoTest는 단위 테스트가 아니라고 봐야 할까? 그렇지는 않다.  
(중략)  
이렇게 사용할 DB의 상태를 테스트가 관장하고 있다면 이를 단위 테스트라고 해도 된다.
>

위 내용은 DB를 통제하여 항상 일관된 테스트 결과를 얻을 수 있다면 단위 테스트라고 말해도 된다는 내용이다.

DB를 통제할 수 있게 된다면 어떤 테스트를 실행했을 때 항상 동일한 결과를 얻을 수 있다.  
그렇다면 이처럼 테스트에서 DB를 통제할 수 있는 방법은 무엇이 있을까?  
이 글은 테스트에서 DB를 통제할 수 있는 방법은 무엇이 있을지 생각해보고 그 방법의 문제점과 이를 개선하기 위한 다른 방법들은 무엇이 있을지 작성해보려고 한다.

<br>

### 1. 원격 서버에 있는 DB 접근

첫 번째로 생각해본 방법은 개발자들의 PC에 있는 DB에서 테스트하는 것이 아니라 aws rds나 외부의 특정 서버에 설치된 db에 접근하여 테스트하는 것이다.  

이 방법의 문제는 다음과 같다
- 원격 서버에 있는 db에 접근하기 위해서는 인터넷 연결이 반드시 필요하다는 점이다.
- 만약 인터넷에 개발자의 컴퓨터가 접속이 불가능하거나, 원격 서버에 있는 db가 정상적으로 작동하지 않는 등의 문제로 원격 서버에 있는 db에 접근하지 못한다면 db 자체를 사용하지 못하게 된다.

<br>

### 2. 인 메모리 DB 사용

두 번째로 생각해본 방법은 개발자들의 PC에 인메모리 DB를 설치하여 테스트하는 것이다.  
인메모리 DB를 사용한다면 테스트할 때 인터넷에 접근할 필요가 없기 때문에 원격 서버에 있는 DB 접근 방법의 문제점을 해결할 수 있다.  
또한 MySql 등은 디스크에 데이터를 저장하기 때문에 속도가 느리지만, 인메모리 DB는 메모리에 저장하기 때문에 속도가 빨라 테스트시 적합하다.  

하지만 이 방법 또한 다음과 같은 문제가 있다.
- 제품 코드가 사용하는 DB 환경과 테스트 코드를 실행하는 DB 환경이 다르다는 것이 문제가 된다.
- 예를 들어 테스트 환경에서는 H2를 사용하고 프로덕션 환경에서는 MySql을 사용할 때, 테스트 환경에서는 올바르게 동작하는데, H2에서만 사용하는 비표준 SQL을 사용하여 프로덕션 환경에서 쿼리가 제대로 동작하지 않을 수 있다.

<br>

### 3. 프로덕션 환경에서 사용하는 DB와 테스트 환경에서 사용하는 DB를 동일하게 맞춰주는 방법

세 번째로 생각해본 방법은 프로덕션 환경에서 사용하는 DB를 테스트 환경에서도 사용하는 것이다.  
제품 코드가 사용하는 DB 환경과 테스트 코드를 실행하는 DB 환경이 달라 발생하는 문제를 해결할 수 있다.  

하지만 이 방법 또한 다음과 같은 문제가 있다.
- 테스트를 실행하는 pc마다 테스트에 사용할 db를 설치하고 환경을 구축한 후에 테스트해야 한다는 문제이다.
- 이 문제는 개발자가 추가될 때마다 테스트 db 환경을 구축해야 한다는 귀찮음이 존재한다.

<br>

### 4. TestContainer 사용

마지막으로 생각해본 방법은 TestContainer를 사용하는 것이다.  
도커만 설치되어 있다면 도커 이미지를 다운 받아 로컬 환경에서 동일한 테스트 환경을 쉽게 구축할 수 있고, container 마다 독립적으로 수행되어 **멱등성을 보장**할 수 있다.  

하지만 이러한 TestContainer도 단점이 존재한다.
- 독립적인 테스트 환경이 많아질수록 시간이 오래 걸린다
- 도커 컨테이너를 사용하여 테스트 환경을 구성해 로컬 환경의 리소스가 충분해야 한다.
- 테스트 속도가 느릴 수 있다.  

**Test Container란?**
- 통합 테스트를 지원하기 위해 개발된 오픈 소스 Java 라이브러리이다.
- 도커 컨테이너를 활용하여 외부 의존성들을 포함한 테스트 환경을 구축하고 관리하는 것을 간편하게 해주고, container마다 독립적으로 수행되어 **멱등성을 유지**해준다

<br>

## 결론

### 정리

테스트 시 db를 어떻게 통제할 수 있을지 방법들에 대해서 알아보았다.  
테스트에서 DB를 통제할 수 있는 방법은 무엇이 있을지 생각해보고 그 방법의 문제점과 이를 개선하기 위한 다른 방법들은 무엇이 있는지 알아보았다.  
결국에는 항상 멱등성을 보장할 수 있는 TestContainer를 이용하여 db를 통제할 수 있다는 것을 알았다.  
다음에는 TestContainer에 대해 자세히 알아보자.

### 생각
이전 프로젝트들에서 통합 테스트를 진행하면서, 멱등성을 유지하면서 테스트 환경을 쉽게 설정할 수 있는 방법을 고민했었는데, 이번 기회를 통해 이 고민을 해결할 수 있는 실마리를 얻었다.